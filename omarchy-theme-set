#!/bin/bash

if [[ -z $1 && $1 != "CNCLD" ]]; then
  echo "Usage: omarchy-theme-set <theme-name>"
  exit 1
fi

CURRENT_THEME_PATH="$HOME/.config/omarchy/current/theme"
NEXT_THEME_PATH="$HOME/.config/omarchy/current/next-theme"
USER_THEMES_PATH="$HOME/.config/omarchy/themes"
OMARCHY_THEMES_PATH="${OMARCHY_PATH:-/usr/share/omarchy}/themes"

THEME_NAME=$(echo "$1" | sed -E 's/<[^>]+>//g' | tr '[:upper:]' '[:lower:]' | tr ' ' '-')

# Find theme in user themes or system themes
if [[ -d "$USER_THEMES_PATH/$THEME_NAME" ]]; then
  THEME_PATH="$USER_THEMES_PATH/$THEME_NAME"
elif [[ -d "$OMARCHY_THEMES_PATH/$THEME_NAME" ]]; then
  THEME_PATH="$OMARCHY_THEMES_PATH/$THEME_NAME"
else
  echo "Theme '$THEME_NAME' does not exist"
  exit 1
fi

# Omarchy 3.3+ template-based theme application
# Copy theme to next-theme directory, generate configs from colors.toml, then activate
rm -rf "$NEXT_THEME_PATH"
mkdir -p "$NEXT_THEME_PATH"

cp -r "$THEME_PATH/"* "$NEXT_THEME_PATH/" 2>/dev/null

# Generate app configs from colors.toml using Omarchy's template system (if available)
if command -v omarchy-theme-set-templates >/dev/null 2>&1; then
  omarchy-theme-set-templates
fi

# Atomically move next-theme to current theme
rm -rf "$CURRENT_THEME_PATH"
mv "$NEXT_THEME_PATH" "$CURRENT_THEME_PATH"

# Save theme name for reference
echo "$THEME_NAME" > "$HOME/.config/omarchy/current/theme.name"

# Change background with theme
omarchy-theme-bg-next

# Restart components to apply new theme
if pgrep -x waybar >/dev/null; then
  omarchy-restart-waybar
fi
omarchy-restart-swayosd 2>/dev/null
hyprctl reload 2>/dev/null
pkill -SIGUSR2 btop 2>/dev/null
makoctl reload 2>/dev/null

# Apply tool-specific themes
omarchy-theme-set-terminal 2>/dev/null
omarchy-theme-set-gnome 2>/dev/null
omarchy-theme-set-browser 2>/dev/null
omarchy-theme-set-vscode "$THEME_NAME" 2>/dev/null
omarchy-theme-set-cursor 2>/dev/null
omarchy-theme-set-obsidian 2>/dev/null
omarchy-theme-set-zed 2>/dev/null
omarchy-theme-set-gtk 2>/dev/null

# Call hook on theme set
omarchy-hook theme-set "$THEME_NAME" 2>/dev/null
